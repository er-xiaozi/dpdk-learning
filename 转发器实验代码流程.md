## 转发器实验代码流程

### 一、启动转发器

主机A、B

```
echo 1024 > /sys/kernel/mm/hugepages/hugepages-2048kB/nr_hugepages
ndndpdk-svc
sudo ifconfig ens160 down
sudo modprobe vfio-pci
modprobe vfio enable_unsafe_noiommu_mode=1
echo 1 > /sys/module/vfio/parameters/enable_unsafe_noiommu_mode
sudo dpdk-devbind.py -b vfio-pci 03:00.0
ndndpdk-ctrl activate-forwarder < /home/lwj/Desktop/forwarder.schema.json
ndndpdk-ctrl create-eth-port --pci 03:00.0 --mtu 1500
```

主机A

```
ndndpdk-ctrl create-ether-face --local 00:0c:29:a1:cb:21 --remote 00:0c:29:57:30:2a
```

主机B

```
ndndpdk-ctrl create-ether-face --local 00:0c:29:57:30:2a --remote 00:0c:29:a1:cb:21
```

主机A插入FIB

```
ndndpdk-ctrl insert-fib --name /example/P --nh 3O8JGALFV96LPVG
```

ping

```
主机 A $ ndndpdk-godemo pingclient --name /example/P
主机 B $ ndndpdk-godemo pingserver --name /example/P
```

启动完成，此时可以看到两个主机之间能够通信。

### 二、pingclient、pingserver的实现

pingclient和pingserver启动后的运行逻辑在cmd/ndndpdk-godemo/ping.go

里面有两个初始化函数`func init()`分别对应pingclient和pingserver

```
func init() {
	var name string
	var interval, lifetime time.Duration
	var wantVerify bool
	defineCommand(&cli.Command{
		Name:  "pingclient",
		Usage: "Reachability test client: periodically send Interest under a prefix.",
		Flags: []cli.Flag{
			&cli.StringFlag{
				Name:        "name",
				Usage:       "consumer name `prefix`",
				Destination: &name,
				Required:    true,
			},
			&cli.DurationFlag{
				Name:        "interval",
				Usage:       "the `interval` between Interests",
				Value:       100 * time.Millisecond,
				Destination: &interval,
			},
			...
```

代码使用了 `cli` 库来解析命令行参数

`pingclient` 是一个客户端程序，它定期向服务器发送 Interest 并测量往返时间 (RTT)。

- **命令行参数**：
  - `name`：这是 NDN consumer 的前缀，用于构造 Interest 请求的前缀。
  - `interval`：两次 Interest 请求之间的时间间隔。
  - `lifetime`：Interest 请求的生命周期。
  - `verified`：是否启用数据包的签名验证（使用 `SigSha256`）。

以上是client参数设置，可以通过命令行输入，下面运行了openUplink


```
Before: openUplink,
```

这一行是个自定义函数，在cmd/ndndpdk-godemo/main.go中

```
func openUplink(c *cli.Context) (e error) {
	switch client := client.(type) {             //判断client类型，采用GraphQL管理NDN-DPDK，还是默认命令行管理
	case *gqlmgmt.Client:						 //GraphQL管理
		var loc memiftransport.Locator
		loc.Dataroom = mtuFlag
		face, e = client.OpenMemif(loc)
	default:									// GraphQL管理
		face, e = client.OpenFace()				// OpenFace()
	}
	if e != nil {
		return e
	}
	l3face := face.Face()

	fw := l3.GetDefaultForwarder()
	if fwFace, e = fw.AddFace(l3face); e != nil {
		return e
	}
	fwFace.AddRoute(ndn.Name{})
	fw.AddReadvertiseDestination(face)

	log.Printf("uplink opened, state is %s", l3face.State())
	l3face.OnStateChange(func(st l3.TransportState) {
		log.Printf("uplink state changes to %s", l3face.State())
	})
	return nil
}
```


